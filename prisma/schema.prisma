generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ///////////////////////////// //
//             Enums             //
// ///////////////////////////// //

enum AudioFor {
  DONE_SOUND
}

enum LlmType {
  OPENAI_API_KEY
  OPENAI_LOGIN_TOKEN
}

enum AuthProvider {
  GITHUB
}

enum TaskState {
  Creating
  SettingUp
  Working
  Validating
  Reviewing
  AwaitingReview
  Halting
  Failed
}

// ///////////////////////////// //
//              Core             //
// ///////////////////////////// //

model Workspace {
  id String @id @default(uuid())

  name                     String
  description              String   @default("")
  sourceRepoUrl            String?  @map("source_repo_url")
  customDockerfileCommands String   @default("") @map("custom_dockerfile_commands")
  setupScript              String   @default("") @map("setup_script")
  postScript               String   @default("") @map("post_script")
  cacheFiles               String[] @default([]) @map("cache_files")

  envEntries WorkspaceEnv[]
  tasks      Task[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
}

model WorkspaceEnv {
  id String @id @default(uuid())

  workspaceId String    @map("workspace_id")
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  key   String
  value String
}

model Task {
  id String @id @default(uuid())

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  workspaceId String    @map("workspace_id")
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  llmId String @map("llm_id")
  llm   Llm    @relation(fields: [llmId], references: [id])

  authAccountId String
  authAccount   AuthAccount @relation(fields: [authAccountId], references: [id])

  messages Message[]

  name      String?
  issueLink String? @map("issue_link")

  // Git source
  sourceGitBranch String? @map("source_git_branch")

  // Git push
  workGitBranch         String? @map("work_git_branch")
  pullRequestLink       String? @map("pull_request_link")
  isPullRequestUpToDate Boolean @default(false) @map("is_pull_request_up_to_date")
  isMerged              Boolean @default(false) @map("is_merged")
  isBehind              Boolean @default(false) @map("is_behind")

  container     String    @map("container")
  containerName String?   @map("container_name")
  archived      Boolean   @default(false)
  state         TaskState @default(SettingUp)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
}

model Message {
  id String @id @default(uuid())

  taskId String @map("task_id")
  task   Task   @relation(fields: [taskId], references: [id])

  role    String
  content String

  createdAt DateTime @default(now()) @map("created_at")
}

model Llm {
  id String @id @default(uuid())

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  // Provider
  type LlmType

  // Details
  name           String? @map("name")
  isDefault      Boolean @default(false) @map("is_default")
  preferredModel String? @map("preferred_model")

  // Auth
  apiKey       String?   @map("api_key")
  accessToken  String?   @map("access_token")
  refreshToken String?   @map("refresh_token")
  expiresAt    DateTime? @map("expires_at")

  // Statistics
  tokensUsed Int  @default(0) @map("tokens_used")
  tokenLimit Int? @map("token_limit")

  // Metadata
  lastUsedAt DateTime? @map("last_used_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  tasks Task[]

  @@map("llms")
}

model AuthAccount {
  id String @id @default(uuid())

  // Provider
  provider    AuthProvider
  accessToken String       @map("access_token")
  scope       String

  // Auth identity
  name String

  // Details
  username String
  email    String

  // Metadata
  lastUsedAt DateTime? @map("last_used_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  tasks Task[]

  @@unique([provider, username])
  @@map("auth_accounts")
}

// ///////////////////////////// //
//           Framework           //
// ///////////////////////////// //

model User {
  id String @id @default(uuid())

  settings   UserSettings?
  audioFiles AudioFile[]
  threads    Task[]
  llms       Llm[]

  username String @unique
  name     String

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
}

model UserSettings {
  id String @id @default(uuid())

  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  doneSoundAudioFileId String?    @unique @map("done_sound_audio_file_id")
  doneSoundAudioFile   AudioFile? @relation("DoneSoundAudioFile", fields: [doneSoundAudioFileId], references: [id])

  voiceEnabled Boolean @default(true)
  voiceHotkey  String  @default("Control+Num0")

  language   String? @default("auto")
  theme      String? @default("system")
  codeEditor String? @default("code") @map("preferred_code_editor")

  customAgentInstructions String  @default("") @map("custom_agent_instructions")
  customAgentsFile        String? @map("custom_agents_file")

  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("user_settings")
}

model AudioFile {
  id String @id @default(uuid())

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  // Details
  audioFor  AudioFor @map("audio_for")
  fileName  String   @map("file_name")
  mimeType  String   @map("mime_type")
  sizeBytes Int      @map("size_bytes")
  data      Bytes

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  doneSoundSetting UserSettings? @relation("DoneSoundAudioFile")

  @@unique([userId, audioFor])
  @@map("audio_files")
}
