generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Workspace {
  id String @id @default(uuid())

  name           String
  description    String   @default("")
  repository     String
  setupScript    String   @default("") @map("setup_script")
  postScript     String   @default("") @map("post_script")
  cacheFiles     String[] @default([]) @map("cache_files")
  containerImage String   @map("container_image")

  envEntries WorkspaceEnv[]
  tasks      Task[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
}

model WorkspaceEnv {
  id String @id @default(uuid())

  workspaceId String    @map("workspace_id")
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  key   String
  value String
}

model Task {
  id String @id @default(uuid())

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  workspaceId String    @map("workspace_id")
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  messages Message[]

  name      String
  branch    String
  container String  @map("container")
  archived  Boolean @default(false)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
}

model Message {
  id String @id @default(uuid())

  taskId String @map("task_id")
  task   Task   @relation(fields: [taskId], references: [id])

  role    String
  content String

  createdAt DateTime @default(now()) @map("created_at")
}

model User {
  id String @id @default(uuid())

  settings UserSettings?
  threads  Task[]

  username String @unique
  name     String

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
}

model UserSettings {
  id String @id @default(uuid())

  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  voiceEnabled Boolean @default(true)
  voiceHotkey  String  @default("Control+Num0")

  openAiApiKey String? @map("openai_api_key")

  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("user_settings")
}

enum AuthProvider {
  GITHUB
}

model AuthAccount {
  id String @id @default(uuid())

  // Provider
  provider          AuthProvider
  providerAccountId String       @map("provider_account_id")
  accessToken       String       @map("access_token")
  tokenType         String       @map("token_type")
  scope             String

  // Details
  username    String
  displayName String  @map("display_name")
  avatarUrl   String? @map("avatar_url")
  email       String?

  // Metadata
  lastUsedAt DateTime? @map("last_used_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  @@unique([provider, providerAccountId])
  @@map("auth_accounts")
}

model OAuthState {
  id String @id @default(uuid())

  provider              AuthProvider
  state                 String       @unique
  callbackUrl           String       @map("callback_url")
  completionRedirectUrl String?      @map("completion_redirect_url")
  scopes                String[]     @default([]) @map("scopes")

  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")

  @@map("oauth_states")
}
