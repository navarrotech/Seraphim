generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Workspace {
  id String @id @default(uuid())

  // Git identity
  gitUserName  String @default("") @map("git_user_name")
  gitUserEmail String @default("") @map("git_user_email")

  // Import
  authAccountId String?      @map("auth_account_id")
  authAccount   AuthAccount? @relation(fields: [authAccountId], references: [id])

  name                     String
  description              String   @default("")
  repository               String
  customDockerfileCommands String   @default("") @map("custom_dockerfile_commands")
  setupScript              String   @default("") @map("setup_script")
  postScript               String   @default("") @map("post_script")
  cacheFiles               String[] @default([]) @map("cache_files")
  containerImage           String   @map("container_image")

  envEntries WorkspaceEnv[]
  tasks      Task[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
}

model WorkspaceEnv {
  id String @id @default(uuid())

  workspaceId String    @map("workspace_id")
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  key   String
  value String
}

model Task {
  id String @id @default(uuid())

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  workspaceId String    @map("workspace_id")
  workspace   Workspace @relation(fields: [workspaceId], references: [id])

  connectionId String     @map("connection_id")
  connection   Connection @relation(fields: [connectionId], references: [id])

  messages Message[]

  name      String
  branch    String
  container String    @map("container")
  containerName String? @map("container_name")
  archived  Boolean   @default(false)
  state     TaskState @default(SettingUp)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
}

model Message {
  id String @id @default(uuid())

  taskId String @map("task_id")
  task   Task   @relation(fields: [taskId], references: [id])

  role    String
  content String

  createdAt DateTime @default(now()) @map("created_at")
}

model User {
  id String @id @default(uuid())

  settings    UserSettings?
  audioFiles  AudioFile[]
  threads     Task[]
  connections Connection[]

  username String @unique
  name     String

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
}

model UserSettings {
  id String @id @default(uuid())

  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  doneSoundAudioFileId String?    @unique @map("done_sound_audio_file_id")
  doneSoundAudioFile   AudioFile? @relation("DoneSoundAudioFile", fields: [doneSoundAudioFileId], references: [id])

  voiceEnabled Boolean @default(true)
  voiceHotkey  String  @default("Control+Num0")

  language String? @default("auto")
  theme    String? @default("system")

  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("user_settings")
}

model AudioFile {
  id String @id @default(uuid())

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  // Details
  audioFor  AudioFor @map("audio_for")
  fileName  String   @map("file_name")
  mimeType  String   @map("mime_type")
  sizeBytes Int      @map("size_bytes")
  data      Bytes

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  doneSoundSetting UserSettings? @relation("DoneSoundAudioFile")

  @@unique([userId, audioFor])
  @@map("audio_files")
}

enum AudioFor {
  DONE_SOUND
}

enum LlmConnectionType {
  OPENAI_API_KEY
  OPENAI_LOGIN_TOKEN
  KIMI_API_KEY
}

enum TaskState {
  SettingUp
  Working
  Validating
  Reviewing
  AwaitingReview
  Failed
}

model Connection {
  id String @id @default(uuid())

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  // Provider
  type LlmConnectionType

  // Details
  name           String? @map("name")
  isDefault      Boolean @default(false) @map("is_default")
  preferredModel String? @map("preferred_model")

  // Auth
  apiKey       String?   @map("api_key")
  accessToken  String?   @map("access_token")
  refreshToken String?   @map("refresh_token")
  expiresAt    DateTime? @map("expires_at")

  // Statistics
  tokensUsed Int  @default(0) @map("tokens_used")
  tokenLimit Int? @map("token_limit")

  // Metadata
  lastUsedAt DateTime? @map("last_used_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  tasks Task[]

  @@map("connections")
}

enum AuthProvider {
  GITHUB
}

model AuthAccount {
  id String @id @default(uuid())

  // Provider
  provider    AuthProvider
  accessToken String       @map("access_token")
  scope       String

  // Auth identity
  name String

  // Details
  username String
  email    String

  // Metadata
  lastUsedAt DateTime? @map("last_used_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  workspaces Workspace[]

  @@unique([provider, username])
  @@map("auth_accounts")
}
